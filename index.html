<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primary Maths Digital Textbook</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #121212; color: white; margin: 0; padding-bottom: 70px; overflow-x: hidden; }
        
        #lock-screen, #terms-screen { text-align: center; padding: 40px 20px; }
        #terms-screen { display: none; } /* Hidden by default */
        #pdf-main-container { display: none; width: 100%; }
        
        #topic-header {
            position: sticky; top: 0; background: #1e1e1e;
            padding: 15px; z-index: 1000; border-bottom: 2px solid #333;
            display: flex; justify-content: center;
        }

        #topic-selector {
            width: 90%; max-width: 500px; padding: 12px;
            border-radius: 10px; background: #2c2c2c; color: white;
            font-size: 1rem; border: 1px solid #555;
        }

        .btn { padding: 15px; margin: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 80%; max-width: 300px; }
        .mtn { background: #ffcc00; color: black; }
        .airtel { background: #ff0000; color: white; }
        
        #pdf-viewer { 
            display: flex; flex-direction: column; align-items: center; 
            width: 100%; margin: 0 auto; padding: 0;
        }
        #pdf-viewer canvas { 
            max-width: 100%; height: auto !important; 
            margin: 5px 0; background: white;
        }
        
        #page-loader { 
            position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #4CAF50; padding: 15px 25px; 
            border-radius: 15px; display: none; z-index: 2000; font-size: 1rem;
            width: 80%; max-width: 300px; text-align: center; border: 1px solid #4CAF50;
        }
        #progress-container {
            width: 100%; background: #333; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden;
        }
        #progress-bar {
            width: 0%; height: 100%; background: #4CAF50; transition: width 0.2s;
        }

        .static-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1a1a1a; color: #bbb; text-align: center;
            padding: 15px 0; font-size: 0.8rem; border-top: 1px solid #333;
            z-index: 3000; display: flex; justify-content: center; align-items: center; flex-wrap: wrap;
        }
        .wa-icon { width: 18px; height: 18px; margin: 0 5px; vertical-align: middle; }
        .instruction-box { background: #222; border: 1px dashed #555; padding: 15px; margin: 20px auto; width: 90%; max-width: 400px; border-radius: 10px; }
        
        /* Terms Box Styling */
        .terms-box { 
            background: #1a1a1a; border: 2px solid #ff0000; padding: 20px; 
            text-align: left; margin: 20px auto; width: 90%; max-width: 500px; 
            border-radius: 10px; line-height: 1.6; font-size: 0.9rem;
        }
        .warning-text { color: #ff0000; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h2 id="admin-trigger">üîí Book Locked</h2>
    <div class="instruction-box">
        <p style="color:#ffcc00; font-weight:bold; margin-top:0;">HOW TO UNLOCK:</p>
        <p>Message the author with the ID below to receive your unlock code.</p>
        <p>Device ID: <strong id="device-id" style="color:#00ff00; font-size:1.2rem;">...</strong></p>
    </div>
    <button class="btn mtn" onclick="sendWA('256785600165')">Message Author (MTN)</button>
    <button class="btn airtel" onclick="sendWA('256703078891')">Message Author (Airtel)</button>
    <br><br>
    <input type="text" id="user-key" placeholder="Enter Unlock Code" style="padding: 15px; width: 250px; border-radius: 8px; border: 1px solid #444; background: #000; color: white; text-align:center; font-size:1.1rem;">
    <br>
    <button class="btn" style="background: #4CAF50; color: white;" onclick="checkCode()">Unlock Now</button>
</div>

<div id="terms-screen">
    <h2 style="color: #ffcc00;">‚ö†Ô∏è LEGAL WARNING</h2>
    <div class="terms-box">
        <p class="warning-text">Security Protocol Active:</p>
        <ul>
            <li>This book is digitally watermarked with your <strong>Device ID</strong>.</li>
            <li>Sharing screenshots, recordings, or printing any part of this book is <strong>STRICTLY PROHIBITED</strong>.</li>
            <li>Any attempt to distribute this content will result in an <strong>IMMEDIATE PERMANENT BLOCK</strong> of your Device ID.</li>
            <li>Blacklisted devices cannot be re-activated even with a new code.</li>
            <li> By using this service, you acknowledge that the author maintains the right to monitor app activity and may suspend
                or block access for any user who violates these terms or engages in misconduct.</li>
        </ul>
        <p>By clicking "I AGREE", you accept full responsibility for the safety of this digital copy.</p>
    </div>
    <button class="btn" style="background: #4CAF50; color: white;" onclick="acceptTerms()">I AGREE & OPEN BOOK</button>
</div>

<div id="pdf-main-container">
    <div id="topic-header">
        <select id="topic-selector" onchange="loadTopic(this.value)">
            <option value="topic6.pdf">1. Set Concepts</option>
            <option value="topic5.pdf">2. Whole Numbers</option>
            <option value="topic1.pdf">3. Operations on Whole Numbers</option>
            <option value="topic3.pdf">4. Patterns and Sequences</option>
            <option value="topic9.pdf">5. Fractions</option>
            <option value="topic8.pdf">6. Data Handling</option>
            <option value="topic10.pdf">7. Geometric Construction</option>
            <option value="topic4.pdf">8. Integers and Finite Systems</option>
            <option value="topic2.pdf">9. Money</option>
            <option value="topic11.pdf">10. Length, Mass, and Capacity</option>
            <option value="topic7.pdf">11. Time</option>
            <option value="topic12.pdf">12. Algebra</option>
        </select>
    </div>
    <div id="pdf-viewer"></div>
    <div id="page-loader">
        <div id="loader-text">Loading Topic...</div>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div id="percent-text" style="font-size: 0.8rem; margin-top: 5px;">0%</div>
    </div>
</div>

<div class="static-footer">
    App developed by Afigram Co. 0749431766 or 
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="wa-icon"> 
    <a href="https://wa.me/256749431766" style="color: #bbb; text-decoration: none;">0749431166</a>
</div>

<script>
const screenDim = window.screen.width * window.screen.height;
const deviceID = Math.floor(screenDim / 3) + window.navigator.userAgent.length;
document.getElementById('device-id').innerText = deviceID;

function calculateComplexCode(id) {
    const mathMagic = Math.abs(Math.sin(id) * 10000000);
    const scramble = (id * 157) + 997;
    const final = Math.floor(mathMagic + scramble) % 100000000;
    return final.toString().padStart(8, '0');
}

let clicks = 0;
document.getElementById('admin-trigger').onclick = function() {
    clicks++;
    if (clicks === 20) {
        const pass = prompt("ADMIN ACCESS:");
        if (pass === "19622003") {
            const sid = prompt("Enter Student ID:");
            if(sid) alert("Unlock Code: " + calculateComplexCode(sid));
        }
        clicks = 0;
    }
};

function sendWA(num) { 
    const msg = encodeURIComponent("Hello, I want to unlock the book. My ID is: " + deviceID);
    window.location.href = `https://wa.me/${num}?text=${msg}`;
}

function checkCode() {
    const input = document.getElementById('user-key').value.trim();
    if (input === calculateComplexCode(deviceID)) {
        localStorage.setItem('unlocked', 'true');
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('terms-screen').style.display = 'block';
    } else { alert("Incorrect Code."); }
}

function acceptTerms() {
    localStorage.setItem('termsAccepted', 'true');
    showBook();
}

function showBook() {
    document.getElementById('lock-screen').style.display = 'none';
    document.getElementById('terms-screen').style.display = 'none';
    document.getElementById('pdf-main-container').style.display = 'block';
    loadTopic('topic6.pdf');
}

const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
let currentTask = null;

async function loadTopic(fileName) {
    const viewer = document.getElementById('pdf-viewer');
    const loader = document.getElementById('page-loader');
    const bar = document.getElementById('progress-bar');
    const pText = document.getElementById('percent-text');
    const lText = document.getElementById('loader-text');
    
    if (currentTask) { await currentTask.destroy(); }
    viewer.innerHTML = '';
    loader.style.display = 'block';
    bar.style.width = '0%';
    pText.innerText = '0%';
    lText.innerText = 'Downloading...';
    window.scrollTo(0,0);

    try {
        const loadingTask = pdfjsLib.getDocument(fileName);
        currentTask = loadingTask;

        loadingTask.onProgress = function(progress) {
            if (progress.total > 0) {
                const percent = Math.round((progress.loaded / progress.total) * 100);
                bar.style.width = percent + '%';
                pText.innerText = percent + '%';
            }
        };

        const pdf = await loadingTask.promise;
        lText.innerText = 'Preparing Pages...';
        
        for (let n = 1; n <= pdf.numPages; n++) {
            const page = await pdf.getPage(n);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            viewer.appendChild(canvas);

            page.render({ canvasContext: ctx, viewport: viewport }).promise.then(() => {
                ctx.font = "bold 35px Arial";
                ctx.fillStyle = "rgba(255, 0, 0, 0.12)";
                ctx.textAlign = "center";
                for (let x = 0; x < canvas.width; x += 350) {
                    for (let y = 0; y < canvas.height; y += 300) {
                        ctx.save(); ctx.translate(x+175, y+150); ctx.rotate(-Math.PI/4);
                        ctx.fillText("ID: " + deviceID, 0, 0); ctx.restore();
                    }
                }
            });
            pText.innerText = `Rendering ${n} of ${pdf.numPages}`;
        }
    } catch (e) { console.error(e); }
    setTimeout(() => { loader.style.display = 'none'; }, 1000);
}

window.onload = () => {
    const isUnlocked = localStorage.getItem('unlocked') === 'true';
    const hasAgreed = localStorage.getItem('termsAccepted') === 'true';
    
    if (isUnlocked && hasAgreed) {
        showBook();
    } else if (isUnlocked && !hasAgreed) {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('terms-screen').style.display = 'block';
    }
};

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>
