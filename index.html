<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Textbook</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; background: #121212; color: white; margin: 0; text-align: center; }
        .card { background: #1e1e1e; padding: 30px; border-radius: 20px; max-width: 400px; margin: 50px auto; border: 1px solid #333; }
        #device-id { background: #000; color: #00ff00; padding: 15px; font-family: monospace; font-size: 1.5rem; margin: 20px 0; border-radius: 10px; }
        .btn { width: 85%; padding: 15px; margin: 8px 0; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-airtel { background: #ff0000; color: white; }
        .btn-mtn { background: #ffcc00; color: black; }
        
        /* Viewer Styling */
        #pdf-main-container { display: none; background: #121212; }
        #page-loader { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; z-index: 100; font-size: 12px; }
        .pdf-page-canvas { display: block; margin: 10px auto; width: 100%; max-width: 800px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="lock-screen" class="card">
        <h2>ðŸ”’ Locked</h2>
        <div id="device-id">Loading ID...</div>
        <button class="btn btn-airtel" onclick="sendWA('256703078891')">Airtel WhatsApp</button>
        <button class="btn btn-mtn" onclick="sendWA('256785600165')">MTN WhatsApp</button>
        <input type="number" id="user-key" placeholder="Enter Code" style="width:80%; padding:10px; margin:10px;">
        <button class="btn" style="background:#007bff; color:white;" onclick="checkCode()">Unlock</button>
    </div>

    <div id="pdf-main-container">
        <div id="page-loader">Loading pages... <span id="current-load">0</span></div>
        <div id="pdf-viewer"></div> </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let pdfDoc = null;
        const viewer = document.getElementById('pdf-viewer');

        // This function creates a canvas for a specific page and renders it
        async function renderAllPages(pdf) {
            for (let num = 1; num <= pdf.numPages; num++) {
                const page = await pdf.getPage(num);
                const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale for clarity
                
                // Create a new canvas element for this page
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Add canvas to the viewer
                viewer.appendChild(canvas);

                // Render the page into the canvas
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                
                // Update progress indicator
                document.getElementById('current-load').innerText = `${num} / ${pdf.numPages}`;
            }
            document.getElementById('page-loader').style.display = 'none';
        }

        function showBook() {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('pdf-main-container').style.display = 'block';
            
            pdfjsLib.getDocument('mybook.pdf').promise.then(pdf => {
                pdfDoc = pdf;
                renderAllPages(pdf);
            }).catch(err => {
                alert("Error: Ensure mybook.pdf is in the same folder.");
            });
        }

        // --- ID & Auth Logic ---
        const screenKey = window.screen.width * window.screen.height;
        const deviceID = Math.floor(screenKey / 7) + window.navigator.userAgent.length;
        document.getElementById('device-id').innerText = deviceID;
        
        function checkCode() {
            if (parseInt(document.getElementById('user-key').value) === (parseInt(deviceID) + 19622003)) {
                localStorage.setItem('unlocked', 'true');
                showBook();
            } else { alert("Wrong Code"); }
        }

        function sendWA(n) { window.location.href=`https://wa.me/${n}?text=ID:${deviceID}`; }
        if(localStorage.getItem('unlocked') === 'true') { showBook(); }
    </script>
</body>
</html>
